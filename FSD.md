# File Specification Document (FSD)
## Archive.aero - Historical Aeronautical Chart Viewer System

**Version:** 3.0
**Last Updated:** 2026-01-13
**Maintainer:** Ryan Hemenway

---

## Table of Contents

1. [System Overview](#system-overview)
2. [Architecture](#architecture)
3. [Frontend Specification (index.html)](#frontend-specification-indexhtml)
4. [Backend Specification (faa_chart_slicer_gui.py)](#backend-specification-faa_chart_slicer_guipy)
5. [Data Specifications](#data-specifications)
6. [PMTiles and Tile System Specification](#pmtiles-and-tile-system-specification)
7. [Deployment](#deployment)
8. [Performance Considerations](#performance-considerations)

---

## 1. System Overview

### 1.1 Purpose
Archive.aero provides an interactive, timeline-based viewer for historical FAA sectional charts. The system consists of:

1. **Frontend Viewer** (`index.html`) - Leaflet-based interactive map UI
2. **Backend Processor** (`faa_chart_slicer_gui.py`) - Python GUI for chart processing and PMTiles/tile generation

### 1.2 Technology Stack

**Frontend:**
- HTML5/CSS3/JavaScript (ES6+)
- Leaflet.js 1.9.4
- PapaParse 5.4.1
- PMTiles 3.0.6
- Protomaps Leaflet 4.0.0
- Plausible Analytics
- Buy Me a Coffee widget

**Backend:**
- Python 3.7+
- GDAL/OGR (geospatial processing)
- Tkinter (GUI)
- gdal2tiles.py
- Optional: pmtiles CLI or Python pmtiles package
- Optional: rclone (R2 upload)

### 1.3 Data Flow

```
Raw Chart TIFFs + Shapefiles + master_dole.csv
                 |
                 v
       faa_chart_slicer_gui.py
        |        |        |
        v        v        v
     PMTiles   Tiles    COG/GeoTIFF
        |
        v
     index.html + dates.csv
```

---

## 2. Architecture

### 2.1 System Architecture

```
┌──────────────────────────────────────────────────────────┐
│                    User's Web Browser                    │
│  ┌────────────────────────────────────────────────────┐  │
│  │             index.html (Frontend)                  │  │
│  │  - Leaflet map                                     │  │
│  │  - PMTiles loading                                 │  │
│  │  - Timeline controls                               │  │
│  │  - Search, share, compare tools                    │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
                           ↓ HTTPS
┌──────────────────────────────────────────────────────────┐
│                 CDN / Static File Server                 │
│                                                          │
│  /dates.csv          - Timeline metadata                 │
│  /pmtiles/           - PMTiles bundles by date           │
│    ├── 2011-10-15.pmtiles                               │
│    └── 2025-08-07.pmtiles                               │
└──────────────────────────────────────────────────────────┘
                           ↑
                    Generated by
                           ↓
┌──────────────────────────────────────────────────────────┐
│         faa_chart_slicer_gui.py (Backend Processor)      │
│  - GDAL warp/cut                                         │
│  - Mosaic VRTs                                           │
│  - PMTiles and XYZ WebP tiles                            │
│  - Optional COG and GeoTIFF outputs                      │
└──────────────────────────────────────────────────────────┘
```

### 2.2 Directory Structure (Repository)

```
archive.aero/
├── index.html
├── dates.csv
├── FSD.md
├── faa_chart_slicer_gui.py
├── master_dole.csv           # Used by batch mode
├── shapefiles/               # Chart boundary definitions
└── output/                   # Generated outputs (local)
```

---

## 3. Frontend Specification (index.html)

### 3.1 Overview
Single-page application that loads timeline metadata from `dates.csv`, then renders a single PMTiles layer per selected date. A secondary map is used for side-by-side comparison.

### 3.2 Global Configuration

```javascript
const CONFIG = {
  baseUrl: 'https://data.archive.aero/sectionals/pmtiles/',
  csvUrl: 'dates.csv',
  initialView: { center: [32.7767, -96.7970], zoom: 10 },
  frames: []
};
```

### 3.3 MapController

**Purpose:** Owns Leaflet map instance and PMTiles layers.

**Key behavior:**
- Initializes Leaflet with Carto dark basemap.
- Adds a branded badge in the top-left and standard zoom control in the top-right.
- Caches PMTiles-backed layers by date.
- Shows **one active chart layer at a time** (no rolling window).
- Preloads the next frame and removes older layers after swap.

**PMTiles loading:**
- Uses `pmtiles.PMTiles(url)` and overrides `layer.createTile` to fetch `getZxy`.
- Tiles are `image/webp` and are rendered from Blob URLs.
- Missing tiles fall back to a transparent 1x1 PNG.

**Layer options:**
- `minZoom: 0`, `maxZoom: 22`
- `keepBuffer: 2`
- `updateWhenIdle: true`, `updateWhenZooming: false`

### 3.4 TimelineApp

**Purpose:** Controls timeline UI and interactions.

**Key behavior:**
- Frames are distributed along the timeline by date (percentage between min/max dates).
- Supports step forward/backward with wraparound.
- Playback runs at 2000ms per frame.
- Debounced scrubbing (250ms) for smoother updates.
- Share links include `date`, `lat`, `lng`, and `zoom` parameters.

**Keyboard shortcuts:**
- `ArrowRight` / `ArrowLeft`: step
- `Space`: play/pause
- `F`: fullscreen
- `S`: share panel
- `?`: shortcuts panel
- `Esc`: close overlays

### 3.5 UI Components

**Header Bar:**
- Logo and branding
- Location search input
- Action buttons: map tools, share, fullscreen, shortcuts, external links

**Map Tools Panel:**
- Chart opacity slider
- Split view toggle (side-by-side compare)

**Share Panel:**
- Generates shareable URL
- Copy to clipboard with fallback to `execCommand`

**Overlays:**
- Shortcuts overlay
- Warning overlay (historical charts only)
- Toast notifications

**Timeline Controls:**
- Previous/next buttons
- Play/pause button
- Ticks with labeled major years
- Dropdown selector

### 3.6 Search and Geolocation

**Location Search:**
- Provider: Nominatim
- Endpoint: `https://nominatim.openstreetmap.org/search`
- Rate limit: 1 request per second
- Uses a custom User-Agent header

**Auto-location:**
- IP-based lookup using `https://ipapi.co/json/`
- Runs only when URL parameters are not provided

**User geolocation:**
- Uses `navigator.geolocation` on button click

### 3.7 Side-by-Side Compare

- A second map (`map2`) is created with its own time selector.
- Split view toggles a CSS class on the body.
- Maps sync on `moveend` with a guard to prevent recursion.
- Map 2 defaults to the previous frame when enabled.

---

## 4. Backend Specification (faa_chart_slicer_gui.py)

### 4.1 Overview
Desktop GUI that processes chart TIFFs into mosaics and outputs PMTiles, XYZ tiles, GeoTIFF, or COG. Three tabs are provided: Manual, Batch, and COG & Upload.

### 4.2 Requirements

**Required:**
- Python 3.7+
- GDAL 3.x with Python bindings
- Tkinter
- gdal2tiles.py

**Optional:**
- pmtiles CLI or Python pmtiles package
- rclone

### 4.3 Core Classes

#### 4.3.1 ProgressTracker
Tracks progress and provides ETA strings for long-running operations.

#### 4.3.2 ChartProcessor
Core processing logic:

- `warp_and_cut(input_tiff, shapefile, output_tiff, format)`
  - Expands input to RGBA (VRT)
  - Warps to EPSG:3857
  - Crops using shapefile cutline
  - Outputs GTiff or VRT

- `build_vrt(input_files, output_vrt)`
  - Builds mosaic VRT from list of warped files

- `expand_vrt_to_rgba(input_vrt, output_vrt)`
  - Ensures RGBA VRT for consistent bands

- `create_combined_tiff(input_vrt, output_tiff)`
  - Produces a single tiled BigTIFF

- `generate_tiles(input_vrt, output_dir, zoom_levels, tile_size)`
  - Runs gdal2tiles with WebP output
  - Uses `--xyz` and `--tilesize` (default 1024)
  - Zoom is auto when blank

- `generate_pmtiles(input_vrt, output_pmtiles, zoom_levels, tile_size)`
  - Step 1: generate XYZ tiles to a temp directory
  - Step 2: convert to PMTiles using `pmtiles convert`
  - Falls back to Python `pmtiles.convert` if CLI missing

- `convert_to_cog(input_path, output_path)`
  - Converts to Cloud Optimized GeoTIFF

- `sync_to_r2(local_dir, remote_dest)`
  - rclone sync with tuned concurrency

#### 4.3.3 BatchProcessor
- Indexes TIFF/ZIP files by edition or Wayback timestamp
- Loads master CSV (`date`, `location`, `edition`, `download_link`)
- Matches charts to files and shapefiles
- Supports ZIP extraction of TIFFs + world files

#### 4.3.4 BatchReviewWindow
Review UI for batch matching with context menu:
- Add file
- Change shapefile
- Remove item

#### 4.3.5 UnifiedAppGUI
Tabs:
- **Manual Mode**: add charts, link shapefiles, process outputs
- **Batch Mode**: review matches, then process per date
- **COG & Upload**: scan for mosaics, convert to COG, upload

**Output formats:** `tiles`, `pmtiles`, `geotiff`, `cog`, `both`

**Defaults:**
- Tile size: 1024
- Output format: geotiff
- Pipeline optimization (VRT): enabled

### 4.4 Batch PMTiles Behavior
When output format is PMTiles in batch mode:
- Uses the most recent available imagery per chart location, including fallback to earlier dates.
- Produces one PMTiles file per date in `output/pmtiles/`.

### 4.5 Output Layouts

**Manual mode:**
```
output/
├── warped_temp/
├── combined.vrt
├── combined.tif
├── combined_cog.tif
├── tiles/
└── pmtiles/
    └── combined.pmtiles
```

**Batch mode (PMTiles):**
```
output/
└── pmtiles/
    ├── 2015-06-25.pmtiles
    └── 2015-08-20.pmtiles
```

**Batch mode (tiles/GeoTIFF/COG):**
```
output/
└── 2015-06-25/
    ├── warped/
    ├── combined_2015-06-25.vrt
    ├── mosaic_2015-06-25.tif
    ├── mosaic_2015-06-25_cog.tif
    └── 0/ 1/ 2/ ...
```

---

## 5. Data Specifications

### 5.1 dates.csv (Frontend)
```csv
date_iso
2011-10-15
2012-09-08
```
- `date_iso` is ISO 8601 (YYYY-MM-DD)

### 5.2 master_dole.csv (Backend)
```csv
date,location,edition,download_link
2015-06-25,Seattle,105,https://web.archive.org/web/20150625120000/...
```
- `download_link` is used to extract Wayback timestamps.

---

## 6. PMTiles and Tile System Specification

### 6.1 PMTiles Files
- One PMTiles file per date: `{date}.pmtiles`
- Served from: `https://data.archive.aero/sectionals/pmtiles/`
- Tiles are WebP and stored in the PMTiles archive

### 6.2 XYZ Tiles (Optional Output)
- Output format when `Generate Tiles` is selected
- Tile scheme: XYZ (required for Leaflet)
- Tile size: configurable (default 1024)

### 6.3 Coordinate System
- EPSG:3857 (Web Mercator)

---

## 7. Deployment

### 7.1 Frontend Deployment
- Static hosting (Cloudflare Pages, Netlify, GitHub Pages, etc.)
- Required files: `index.html`, `dates.csv`

### 7.2 Backend Usage
```bash
python3 faa_chart_slicer_gui.py
```

### 7.3 PMTiles Hosting
- Upload PMTiles folder to CDN origin
- Frontend reads PMTiles by date based on `dates.csv`

---

## 8. Performance Considerations

### 8.1 Frontend
- Debounced timeline scrubbing
- Single active chart layer to limit memory usage
- Optional preload of next frame

### 8.2 Backend
- GDAL warping is CPU-heavy; use SSD and multi-core machines
- VRT optimization reduces disk I/O for batch processing
- Tile size impacts storage and PMTiles size
